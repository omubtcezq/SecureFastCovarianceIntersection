%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   Identification
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{BNPackages/BNBeamer/BNBoxes}[2017/07/03 BN Beamer Boxes]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   Preliminary declarations
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newlength{\shadowsize}
\newlength{\boxroundness}

\setlength{\boxroundness}{3pt}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   Styles
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\setlength{\shadowsize}{3pt}
\tikzset{ BNshadow/.style={blur shadow={shadow blur steps=5, shadow xshift=\shadowsize, shadow yshift=-\shadowsize,shadow blur extra rounding=1.3pt}} }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   TODO: Line Shadow
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\tikzset{
%	blurred line action/.style={
%		line width=\pgflinewidth+.2pt,draw opacity=.1,draw=#1,
%	},
%	blurred line recurs/.code 2 args={%
%		\pgfmathtruncatemacro{\level}{#1-1}%
%		\ifthenelse{\equal{\level}{0}}%
%		{\tikzset{preaction={blurred line action=#2}}}%
%		{\tikzset{preaction={blurred line action=#2,blurred line recurs={\level}{#2}}}}
%	},
%	blurred line/.style={preaction={blurred line recurs={10}{#1}},draw opacity=1,draw=#1},
%}
%
%\tikzset{
%		shadowed/.style={preaction={
%				transform canvas={shift={(1\shadowsize,-1\shadowsize)}},line width=0.9\pgflinewidth,opacity=.2,draw=none,blurred line=black}
%		}
%	}

%
%\tikzset{
%	shadowed/.style={preaction={
%			transform canvas={shift={(0.5\shadowsize,-0.5\shadowsize)}},line width=0.9\pgflinewidth,opacity=.2,#1,preaction={
%				transform canvas={shift={(0.0\shadowsize,-0.0\shadowsize)}},line width=0.9\pgflinewidth,opacity=.1,#1,preaction={
%%					transform canvas={shift={(0.5\shadowsize,-0.5\shadowsize)}},line width=1\pgflinewidth,opacity=.05,#1,
%	}}}},
%}

%\tikzset{
%	shadowed/.style={preaction={
%			transform canvas={shift={(2pt,-1pt)}},opacity=.2,#1,preaction={
%				transform canvas={shift={(3pt,-1.5pt)}},opacity=.1,#1,preaction={
%					transform canvas={shift={(4pt,-2pt)}},opacity=.05,#1,
%	}}}},
%}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   Boxes
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeatletter

\pgfkeys{/BNbox/entities/.cd,
	color/.initial=ISASblue,
	titlecolor/.initial=ISASblue,
	color/.code={\pgfkeyssetvalue{/BNbox/entities/color}{#1}\pgfkeysalso{/BNbox/entities/titlecolor=#1}\setbeamercolor{structure}{fg=\pgfkeysvalueof{/BNbox/entities/color}}},
}

\def\BNbox@set@keys#1{%
	\pgfkeys{/BNbox/entities/.cd,#1}%
}
\def\BNbox@get#1{%
	\pgfkeysvalueof{/BNbox/entities/#1}%
}

%% boxtitle command
\NewDocumentCommand{\boxtitle} {o m} {%
{\textbf{\color{\IfNoValueTF{#1}{\BNbox@get{titlecolor}}{#1}}#2}}%
}

%\newcommand{\titlecolor}{%
%	{\BNbox@get{titlecolor}}%
%}

%% Definition of Box
\tikzset{
	set BNbox/.code={\BNbox@set@keys{#1}%
	},
	BNbox/.style={
		set BNbox={#1},
		shade, top color=white, bottom color=\BNbox@get{color}!30,
		draw=\BNbox@get{color}, very thick, rounded corners=\boxroundness
	}, 
}

\makeatother


% TODO: Adapt these boxes to the novel style BNbox

\tikzstyle{bluebox} =  [BNbox,BNshadow]

%\tikzstyle{redbox} = [align=left, very thick, shade, top color=white, bottom color=red!50!black!20, draw=red!40!black!60,
%inner sep=5pt, inner ysep=5pt, rounded corners=\boxroundness, blur shadow={shadow blur steps=5,shadow blur extra rounding=1.3pt}]
\tikzstyle{redbox} = [BNbox={color=ISASred},BNshadow]

\tikzstyle{greenbox} = [BNbox={color=ISASgreen},BNshadow]

\tikzstyle{orangebox} = [BNbox={color=ISASorange},BNshadow]


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   Asymmetrix Boxes
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\tikzset{
	rectangle with rounded corners north west/.initial=4pt,
	rectangle with rounded corners south west/.initial=4pt,
	rectangle with rounded corners north east/.initial=4pt,
	rectangle with rounded corners south east/.initial=4pt,
}
\makeatletter
\pgfdeclareshape{rectangle with rounded corners}{
	\inheritsavedanchors[from=rectangle] % this is nearly a rectangle
	\inheritanchorborder[from=rectangle]
	\inheritanchor[from=rectangle]{center}
	\inheritanchor[from=rectangle]{north}
	\inheritanchor[from=rectangle]{south}
	\inheritanchor[from=rectangle]{west}
	\inheritanchor[from=rectangle]{east}
	\inheritanchor[from=rectangle]{north east}
	\inheritanchor[from=rectangle]{south east}
	\inheritanchor[from=rectangle]{north west}
	\inheritanchor[from=rectangle]{south west}
	\backgroundpath{% this is new
		% store lower right in xa/ya and upper right in xb/yb
		\southwest \pgf@xa=\pgf@x \pgf@ya=\pgf@y
		\northeast \pgf@xb=\pgf@x \pgf@yb=\pgf@y
		% construct main path
		\pgfkeysgetvalue{/tikz/rectangle with rounded corners north west}{\pgf@rectc}
		\pgfsetcornersarced{\pgfpoint{\pgf@rectc}{\pgf@rectc}}
		\pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@ya}}
		\pgfpathlineto{\pgfpoint{\pgf@xa}{\pgf@yb}}
		\pgfkeysgetvalue{/tikz/rectangle with rounded corners north east}{\pgf@rectc}
		\pgfsetcornersarced{\pgfpoint{\pgf@rectc}{\pgf@rectc}}
		\pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yb}}
		\pgfkeysgetvalue{/tikz/rectangle with rounded corners south east}{\pgf@rectc}
		\pgfsetcornersarced{\pgfpoint{\pgf@rectc}{\pgf@rectc}}
		\pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@ya}}
		\pgfkeysgetvalue{/tikz/rectangle with rounded corners south west}{\pgf@rectc}
		\pgfsetcornersarced{\pgfpoint{\pgf@rectc}{\pgf@rectc}}
		\pgfpathclose
	}
}
\makeatother

\tikzstyle{asymbox} = [very thick,
inner sep=10pt, inner ysep=10pt, shape=rectangle with rounded corners, rectangle with rounded corners north east=5pt,rectangle with rounded corners north west=0pt, rectangle with rounded corners south east=0pt, rectangle with rounded corners south west=5pt]

\tikzstyle{asymboxtitle} =[shape=rectangle with rounded corners, rectangle with rounded corners north east=5pt,rectangle with rounded corners north west=0pt, rectangle with rounded corners south east=0pt, rectangle with rounded corners south west=5pt]


